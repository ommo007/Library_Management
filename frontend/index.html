<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Books - Library Book Management System</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="./index.html">
                <i class="fas fa-book-open me-2"></i>Library Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="./index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">Books</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="auth-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="./login.html">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./register.html">Register</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Flash Messages Container -->
    <div class="container mt-3 flash-messages">
        <!-- Flash messages will be displayed here -->
    </div>
    
    <!-- Main Content -->
    <main class="container mt-4 mb-5">
        <!-- Welcome Banner for Home Page -->
        <div class="hero-section mb-5 rounded">
            <div class="container px-4 py-5 text-center">
                <h1 class="display-5 fw-bold text-white">Welcome to the Library Management System</h1>
                <div class="col-lg-8 mx-auto">
                    <p class="lead mb-4">Discover, borrow, and manage books with ease.</p>
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                        <a href="#book-collection" class="btn btn-primary btn-lg px-4 gap-3">Browse Collection</a>
                        <a href="./login.html" class="btn btn-outline-light btn-lg px-4">Login</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="book-collection">
            <div class="row justify-content-between align-items-center mb-4">
                <div class="col-md-6">
                    <h2 class="mb-0"><i class="fas fa-book me-2"></i>Book Collection</h2>
                </div>
                <div class="col-md-6 text-md-end mt-md-0 mt-3">
                    <a href="./create_book.html" class="btn btn-success librarian-only d-none">
                        <i class="fas fa-plus me-1"></i>Add Book
                    </a>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <form id="search-form" method="GET" action="./index.html">
                        <div class="row g-3">
                            <div class="col-md-8 search-results-container">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="search-input" name="query" class="form-control" 
                                          placeholder="Search by title, author, or ISBN...">
                                </div>
                                <div id="search-results" class="d-none"></div>
                            </div>
                            <div class="col-md-3">
                                <select id="section-filter" name="section" class="form-select">
                                    <option value="0">All Sections</option>
                                    <option value="1">Fiction</option>
                                    <option value="2">Non-Fiction</option>
                                    <option value="3">Science</option>
                                    <option value="4">History</option>
                                </select>
                            </div>
                            <div class="col-md-1 d-grid">
                                <button type="submit" class="btn btn-primary">Search</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Books container -->
            <div class="books-container">
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="books-grid">
                    <!-- Books will be loaded here dynamically -->
                    <div class="col">
                        <div class="card h-100 book-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">The Great Gatsby</h5>
                                <span id="book-1-status" class="badge bg-success">Available</span>
                            </div>
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">by F. Scott Fitzgerald</h6>
                                <p class="card-text small">
                                    <strong>Genre:</strong> Fiction<br>
                                    <strong>Section:</strong> Classics<br>
                                    <strong>ISBN:</strong> 9780743273565
                                </p>
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <a href="./book_detail.html" class="btn btn-sm btn-primary">
                                    <i class="fas fa-info-circle me-1"></i>Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pagination controls will be added here if needed -->
                <nav aria-label="Books pagination" class="mt-4 d-none" id="pagination-controls">
                    <ul class="pagination justify-content-center">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Library Book Management System</h5>
                    <p class="small">Manage your library efficiently</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="small">&copy; 2023 Library Book Management System. All rights reserved.</p>
                    <p class="admin-link small"></p>
                        <a href="./login.html?admin=1" class="text-muted text-decoration-none">
                            <i class="fas fa-lock me-1"></i>Admin Access
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="./main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're running standalone or with backend
            const isStaticFile = window.location.protocol === 'file:';
            const apiBaseUrl = isStaticFile ? '' : 'http://localhost:5000'; // Change to your production backend URL
            
            // Fetch books either from API or show sample data
            if (!isStaticFile) {
                fetch(`${apiBaseUrl}/api/books`, {
                    credentials: 'include' // Include cookies in the request
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(books => {
                        displayBooks(books);
                    })
                    .catch(error => {
                        console.error('Error fetching books:', error);
                        showErrorMessage('Failed to load books. Please try again later.');
                    });
                
                // Also fetch user info to update UI
                fetch(`${apiBaseUrl}/api/user`, {
                    credentials: 'include'
                })
                    .then(response => response.json())
                    .then(userData => {
                        updateAuthUI(userData);
                    })
                    .catch(error => {
                        console.error('Error fetching user data:', error);
                    });
            } else {
                // Add sample books in static mode
                const books = [
                    {
                        id: 1,
                        title: 'The Great Gatsby',
                        author: 'F. Scott Fitzgerald',
                        genre: 'Fiction',
                        section: { name: 'Classics' },
                        isbn: '9780743273565',
                        available: true
                    },
                    {
                        id: 2,
                        title: 'To Kill a Mockingbird',
                        author: 'Harper Lee',
                        genre: 'Fiction',
                        section: { name: 'Classics' },
                        isbn: '9780060935467',
                        available: true
                    },
                    {
                        id: 3,
                        title: '1984',
                        author: 'George Orwell',
                        genre: 'Dystopian',
                        section: { name: 'Fiction' },
                        isbn: '9780451524935',
                        available: false
                    }
                ];
                
                displayBooks(books);
                
                // Check localStorage for simulated login in static mode
                const authData = localStorage.getItem('authData');
                if (authData) {
                    updateAuthUI(JSON.parse(authData));
                }
            }
            
            // Show librarian-only elements if user is librarian
            function updateAuthUI(userData) {
                if (userData && userData.authenticated) {
                    // Update navigation for logged in user
                    const authNav = document.getElementById('auth-nav');
                    if (authNav) {
                        let roleClass = 'badge-student';
                        let roleName = 'Student';
                        
                        if (userData.is_admin) {
                            roleClass = 'bg-danger';
                            roleName = 'Admin';
                        } else if (userData.is_librarian) {
                            roleClass = 'badge-librarian';
                            roleName = 'Librarian';
                        }
                        
                        authNav.innerHTML = `
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" 
                                   data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-user-circle me-1"></i>${userData.username}
                                    <span class="badge ${roleClass}">${roleName}</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                    ${userData.is_admin ? '<li><a class="dropdown-item" href="./admin_dashboard.html"><i class="fas fa-tachometer-alt me-1"></i>Admin Dashboard</a></li><li><hr class="dropdown-divider"></li>' : ''}
                                    <li><a class="dropdown-item" href="#" id="logout-btn">Logout</a></li>
                                </ul>
                            </li>
                        `;
                        
                        // Set up logout button
                        const logoutBtn = document.getElementById('logout-btn');
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                if (isStaticFile) {
                                    localStorage.removeItem('authData');
                                    window.location.href = './index.html';
                                } else {
                                    window.location.href = '/auth/logout';
                                }
                            });
                        }
                    }
                    
                    // Show librarian elements if user is librarian or admin
                    if (userData.is_librarian || userData.is_admin) {
                        document.querySelectorAll('.librarian-only').forEach(el => {
                            el.classList.remove('d-none');
                        });
                    }
                }
            }
            
            // Display books in the grid
            function displayBooks(books) {
                const booksGrid = document.getElementById('books-grid');
                
                if (!books || books.length === 0) {
                    booksGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                No books found. Please try a different search or check back later.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Clear the grid first (except in static mode)
                if (!isStaticFile) {
                    booksGrid.innerHTML = '';
                }
                
                // Add each book to the grid
                books.forEach(book => {
                    const availabilityClass = book.available ? 'bg-success' : 'bg-danger';
                    const availabilityText = book.available ? 'Available' : 'Unavailable';
                    
                    const bookElement = document.createElement('div');
                    bookElement.className = 'col';
                    bookElement.innerHTML = `
                        <div class="card h-100 book-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${book.title}</h5>
                                <span id="book-${book.id}-status" class="badge ${availabilityClass}">${availabilityText}</span>
                            </div>
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">by ${book.author}</h6>
                                <p class="card-text small">
                                    <strong>Genre:</strong> ${book.genre || 'Not specified'}<br>
                                    <strong>Section:</strong> ${book.section?.name || 'Not specified'}<br>
                                    <strong>ISBN:</strong> ${book.isbn || 'Not specified'}
                                </p>
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <a href="${isStaticFile ? './book_detail.html' : '/books/' + book.id}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-info-circle me-1"></i>Details
                                </a>
                            </div>
                        </div>
                    `;
                    
                    booksGrid.appendChild(bookElement);
                });
            }
            
            // Show error message
            function showErrorMessage(message) {
                const flashMessages = document.querySelector('.flash-messages');
                if (flashMessages) {
                    flashMessages.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>
